---
title: false
author: false
output:
  revealjs::revealjs_presentation:
    lib_dir: static
    self_contained: false
    reveal_plugins: ["zoom"]
    transition: slide
    css: styles.css
    incremental: true
    center: false
    theme: simple
    fig_width: 6
    fig_height: 3.5
    reveal_options:
      slideNumber: false
      controls: false
      mouseWheel: false
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
library(highcharter)
file.remove(dir("wdgts/", full.names = TRUE))

knitr::opts_chunk$set(fig.path = "static/img/", echo = TRUE, cache = TRUE, message = FALSE)

options(highcharter.theme =
          hc_theme_smpl(chart = list(
            backgroundColor = "transparent",
            style = list(fontFamily = "Source Sans Pro"))
            ))
source("setup.R")
```

# <br><br>Computación Estadística con R<br><small>Clase 4 <br><br> Rubén Soza</small>{ .center .white data-background="#75AADB" }

# Generación de Reportes Automatizables{ .center .white data-background="#75AADB" }

## {data-background-video="video1.mp4"}

## ¿Qué es R Markdown?

- Marco unificado para ciencia de datos.
- Combina:
    - Código.
    - Resultados.
    - Gráficos.
- Los documentos R Markdown son totalmente reproducibles y automatizables.

## Diferentes formatos de salida

   ![](https://rmarkdown.rstudio.com/images/RMarkdownOutputFormats.png)
   
## Primer vistazo

![](Images/rmark1.png)

## Detrás de escenas

`Ventaja flujo de trabajo de dos pasos:` ¡Se puede crear una amplia gama de formatos de salida!
![](http://r4ds.had.co.nz/images/RMarkdownFlow.png)

- Word: Requiere Microsoft Word instalado.
- PDF: Requiere un compilador de LaTeX instalado.
- HTML.

## Sintaxis
- `*cursiva*` y `_cursiva_` -> *cursiva* y _cursiva_
- `**negrita**` y `__negrita__` -> **negrita** y __negrita__
- `[link](www.rstudio.com)` -> [link](www.rstudio.com)
- `# Encabezado 1`
- `## Encabezado 2`
- `### Encabezado 3`
- imagen: `![](camino/a/imagen.png)`
- ` - lista`

## Código

<p align = "justify">
Podemos ingresar código de R en nuestros documentos utilizando los `chunks`(ctrl + alt + I). Existen opciones que permiten manipular la acción de un chunk en específico en nuestro documento. Algunas opciones son: </p>

Opción  | Efecto
------  | -------------------
include | ¿Muestra el fragmento de código de R y su resultado?
echo    | ¿Muestra el fragmento de código de R?
message | ¿Muestra los mensajes de salida?
warning | ¿Muestra las advertencias?
eval    | ¿Evalúa el fragmento de código?

Para más información ver el siguiente [link](https://www.rstudio.com/wp-content/uploads/2015/03/rmarkdown-reference.pdf)

## YAML

<p align = "justify">
Aquí se escriben opciones generales del documento. Se pueden configurar, entre muchas otras cosas: </p>

- Fuente y formato.
- Tamaños de figuras o gráficos.
- Agregar un CSS.

## Código entre texto

Podemos realizar código r en cualquier oración. Para ello basta escribir

![](Images/rinline.png)

Para mayor información de todo esto, ver el siguiente [link](https://bookdown.org/yihui/rmarkdown/)

## Veamos un ejemplo en R{ .center .white data-background="#75AADB" }

## Reporte de Tablas
<p align = "justify">
Existen diferentes paquetes para generar tablas en tus reportes. Veamos 2 de ellos: `kableExtra` y `DT`. Primero cargamos la base de datos y los paquetes a utilizar: </p>

```{r, message = FALSE}
library(tidyverse)
library(kableExtra)
library(DT)
data(iris)

```

## `kableExtra`

<p align = "justify">
La función `kable()` genera una tabla que puede ser editada utilizando funciones de la librería `kableExtra`. Veamos un ejemplo sencillo: </p>

```{r, eval = FALSE}

kable(iris, "html") %>% 
  kable_styling("striped",position = "center", full_width = F) %>% 
  column_spec(2, bold = T, color = "red") %>% 
  add_header_above(c("Sepal" = 2, "Petal" = 2, " " = 1)) %>% 
  pack_rows("Grupo 1", 1,4) %>% 
  pack_rows("Grupo 2", 5,8) %>% 
  scroll_box(width = "100%", height = "500px") %>% 
  footnote("Tabla de Iris")
```

----
```{r, echo = FALSE}
kable(iris) %>% 
  kable_styling("striped",position = "center", full_width = F) %>% 
  column_spec(2, bold = T, color = "red") %>% 
  add_header_above(c("Sepal" = 2, "Petal" = 2, " " = 1)) %>% 
  pack_rows("Grupo 1", 1,4) %>% 
  pack_rows("Grupo 2", 5,8) %>% 
  scroll_box(width = "100%", height = "500px") %>% 
  footnote("Tabla de Iris")
```
Para mayor información ver este [link](https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html)

## `DT`

La librería `DT` permite realizar tablas más customizables.

```{r, eval = FALSE}
library(DT)
datatable(iris, filter = "top")
```
Para más información ver este [link](https://rstudio.github.io/DT/)

## Actividad I: parte I

<p align = "justify">
Considere el archivo `Actividad I.Rmd`. Convertir los títulos de las secciones de estos párrafos en encabezados utilizando la sintaxis apropiada, usando diferentes niveles de encabezado para las secciones y subsecciones: </p>

- Secciones (encabezados de primer nivel): Introducción, La base de datos, Computando el nivel de dificultad, Computando la incertidumbre, Una métrica final.
- Subsecciones (encabezados de segundo nivel): Chequeando la base de datos, Graficando el perfil de dificultad, Detectando niveles difíciles, Mostrando incertidumbre
- Genere un índice para su archivo

## Actividad I: parte II

- En la línea 10, convertir "Candy Crush Saga" en negrita
- Convertir "King" (línea 10) en un link hacia: https://es.wikipedia.org/wiki/King_(empresa)
- Enfatice el texto en la línea 141 convirtiéndola en itálica
- Incluir la imagen del siguiente link en la Introducción: http://www.garotasgeeks.com/wp-content/uploads/2014/05/candy-crush1-610x240.png

## Actividad I: parte III

- Quitar los mensajes que genera el cargar la librería en la línea 18
- Cargar los datos y mostrar las primeras filas de la base de datos (línea 36) sin que me muestre el código ni los mensajes
- Sabiendo que el código para calcular el número de jugadores y el período que abarcan los datos es 
```{r, eval = FALSE}
range(data$dt)
length(unique(data$player_id))
```

- Completar con un código incrustado la línea 44

## Actividad I: parte IV

- Agregar en el YAML `theme:paper`, `toc:true` y `toc_float:true`.
- ¿Qué pasa si agrego la opción 'code_folding: show'?
- La línea 40 muestra un preview de la base de datos utilizada. Modifique este chunk para mostrar una tabla con la función `kable()`.

# Regresión Lineal en R{ .center .white data-background="#75AADB" }

## Contenidos

<p align = "justify">Se revisarán los siguientes tópicos:</p>

- Regresión lineal simple y múltiple.
- Selección de variables.
- Validación del modelo y análisis de sensibilidad.

## Base de Datos

```{r}
fichier <- "http://www.biostatisticien.eu/springeR/Weight_birth.csv"
mydata <- read_delim(fichier, "\t", escape_double = FALSE, trim_ws = TRUE)
head(mydata)
```

----

<p align = "justify">Transformamos libras a kilogramos y graficamos.</p> 

```{r, fig.height = 4}
mydata <- mydata %>% mutate(LWT = LWT*0.4535923)
plot1 <- ggplot(mydata,aes(x = LWT, y = BWT)) + geom_point() + 
  xlab("Peso de la Madre") + ylab("Peso del niño al nacer")
plot1
```

## Regresión Lineal Simple

<p align = "justify"> El modelo de regresión lineal simple busca explicar el comportamiento medio de cierta variable respuesta $y$ utilizando una variable explicativa $x$. </p>

<p align = "justify"> Su formulación corresponde a </p>

$$y_i = \beta_0 + \beta_1x_i + \epsilon_i,$$ 

<p align = "justify"> donde $\epsilon_i \overset{i.i.d}{\sim} N(0,\sigma^2)$, $\sigma^2 \in \mathbb{R}_+, \beta_0,\beta_1 \in \mathbb{R}$. </p>

----
<p align = "justify"> La función `lm()` permite ajustar el modelo: </p>

```{r, fig.height= 4}
model1 <- lm(BWT ~ LWT, data = mydata)
model1
```

<p align = "justify"> Los paquetes `ggiraph` y `ggiraphExtra` permiten visualizar de forma sencilla e interactiva regresiones lineales utilizando `ggPredict()`. </p>
----
```{r, fig.height= 4}
library(ggiraph); library(ggiraphExtra)
ggPredict(model1,interactive = TRUE)
```

----

### Test sobre los Parámetros

```{r}
res <- summary(model1)
res
```

----

### Elementos del Resumen de un Modelo

```{r}
names(res)
res$coefficients
```

----

### Tabla ANOVA

```{r}
anova(model1)
```

----

### I.C. para los Coeficientes de Regresión

```{r}
confint(model1)
```

----

### Predicción:

```{r}
lwt0 <- c(56, 40)
predict(model1, tibble(LWT = lwt0), interval = "prediction")
predict(model1, tibble(LWT = lwt0), interval = "confidence") 
```

----

### Banda de Confianza de la Recta Estimada

```{r}
ggPredict(model1,interactive = TRUE, se = TRUE)
```

## Regresión Lineal Múltiple

<p align = "justify"> El modelo de regresión lineal simple busca explicar el comportamiento medio de cierta variable respuesta $y$ utilizando variables explicativas $x_1, \ldots, x_p$. </p>

<p align = "justify"> Su formulación corresponde a </p>

$$y_i = \beta_0 + \beta_1x_{1i} + \cdots + \beta_px_{pi} + \epsilon_i,$$ 

<p align = "justify"> donde $\epsilon_i \overset{i.i.d}{\sim} N(0,\sigma^2)$, $\sigma^2 \in \mathbb{R}_+, \beta_0,\beta_1, \ldots, \beta_p \in \mathbb{R}$.</p>

----

Modelaremos BWT utilizando LWT, AGE y SMOKE.

```{r, fig.height=4}
mydata1 <- mydata %>%  select(BWT,LWT,AGE,SMOKE)
library(GGally); library(Rmisc)
pairs <- mydata1 %>% select(-SMOKE) %>% ggpairs()
boxplot <- mydata1 %>% ggplot() + geom_boxplot_interactive(aes(x = factor(SMOKE), y = BWT))+ theme_light()
multiplot(pairs,boxplot,cols = 2)
```

----

### Ajustando el Modelo

```{r}
model2 <- lm(BWT ~ LWT + AGE + factor(SMOKE), data = mydata1)
model2
```

----

### Resumen del Modelo

```{r}
summary(model2)
```

---- 

### Tabla ANOVA

```{r}
anova(model2)
```

----

### I.C. para los Coeficientes

```{r}
confint(model2)
```

----

### Predicción

```{r}
newdata <- tibble("AGE" = 23, "LWT" = 57, "SMOKE" = 1)
predict(model2, newdata, interval = "pred")
predict(model2, newdata, interval = "confidence")
```

----

### Test de Hipótesis para Modelos Anidados

```{r}
anova(model1,model2)
```

----

```{r}
model3 <- lm(BWT ~ LWT + factor(SMOKE), data = mydata1)
anova(model3,model2)
```

----

### Variables con Más de Dos Categorías

```{r}
model4 <- lm(BWT ~ LWT + factor(RACE), data = mydata)
anova(model1,model4)
```

----

### Interacciones

```{r}
model5 <- lm(BWT ~ AGE + SMOKE, data = mydata1)
summary(model5)
```

----

```{r}
model6 <- lm(BWT ~ AGE*SMOKE, data = mydata1)
summary(model6)
```

----

```{r}
ggPredict(model5, se = TRUE, interactive = TRUE)
```

----

```{r}
ggPredict(model6, se = TRUE, interactive = TRUE)
```

## Selección de Variables

<p align = "justify">Los siguientes algoritmos implementados en `R` permiten la selección de variables:</p>

- Método Forward.
- Método Backward.
- Método Stepwise.

----

### Método Forward 

<p align = "justify"> Se parte de un modelo sencillo y luego se agregan variables con algún critero. </p>

```{r}
add1(lm(BWT ~ 1, data = mydata), BWT ~ LWT + AGE + UI + factor(SMOKE) + 
       HT + factor(FVT) + factor(PTL), test = "F")
```

----

### Método Backward

<p align = "justify"> Se parte de un modelo complejo y en cada etapa se elimina la variable menos influyente.</p>

```{r}
drop1(lm(BWT ~ LWT + AGE + UI + factor(SMOKE) + 
       HT + factor(FVT) + factor(PTL), data = mydata), test = "F")
```

----

### Método Stepwise

<p align = "justify"> Combina los dos métodos anteriores. Comienza como el de introducción progresiva, pero en cada etapa se plantea si todaslas variables introducidas deben de permanecer en el modelo. </p>

```{r}
step(lm(BWT ~ 1, data = mydata), BWT ~ LWT + AGE + UI + factor(SMOKE) + 
       HT + factor(FVT) + factor(PTL), direction = "both",trace = FALSE)
```

----

### Comparación de Modelos

<p align = "justify"> Existen diferentes medidas para comparar diferentes modelos de regresión: </p>

- $R^2$ ó $R^2$-ajustado.
- AIC ó BIC.

----

### $R^2$ ó $R^2$-ajustado

```{r}
r2 <- c(summary(model5)$r.squared, summary(model6)$r.squared)
r2.adj <- c(summary(model5)$adj.r.squared, summary(model6)$adj.r.squared )
r2
r2.adj
```
----

### AIC y BIC

<p align = "justify"> Se prefieren los modelos con menor AIC o BIC </p>

```{r}
AIC(model5, model6)
BIC(model5, model6)
```

## Bondad del Ajuste del Modelo

<p align = "justify"> Supongamos que el modelo seleccionado corresponde al siguiente: </p>

```{r}
library(lmtest)
finalmodel <- lm(BWT ~ SMOKE + AGE + LWT + factor(RACE) + UI + HT + SMOKE:AGE, data = mydata)
coeftest(finalmodel)
```

----

###  Anásilis de Residuos

<p align = "jusitfy"> Debemos verificar que los residuos de nuestro modelo cumplen los supuestos preestablecidos. Para ello debemos verificar: </p>

- Normalidad de los residuos.
- Homocedasticidad de la varianza de los residuos.
- Residuos independientes.

----

#### Normalidad de los Residuos

```{r, fig.height= 4}
data <- tibble("fit" = finalmodel$fitted.values, "res" = finalmodel$residuals)
p1 <- ggplot(data, aes(sample = res)) + stat_qq() + stat_qq_line() 
p1
```

----

#### Homocedasticidad de la Varianza de los Residuos

```{r, fig.height = 4}
p1 <- ggplot(data) + geom_point(aes(x = fit, y = res))
p1
```

----

#### Independencia de los Residuos

```{r}
dwtest(BWT ~ SMOKE + AGE + LWT + factor(RACE) + UI + HT + SMOKE:AGE, data = mydata)
```

----

### Identificación de Outliers

```{r, fig.height=4, size= 1}
library(ggrepel)
data <- data %>% mutate("res_stud" = rstudent(finalmodel), labels = seq(1,nrow(data))) 
ggplot(data, aes(x = fit, y = res_stud, label = labels)) + geom_point() +
  geom_hline(yintercept = qnorm(0.025)) + geom_hline(yintercept = qnorm(0.975)) +
  geom_text(hjust = 1.5, size = 2.5, check_overlap = TRUE) + xlab("Valores ajustados") + 
  ylab("Residuos Studentizados")

```

----

### Identificación de Puntos Influyentes

<p align = "justify"> Algunos test para su detección son:</p>

- Distancia de Cook.
- DFFITS.
- DFBETAS.
- COVRATIO.

---- 

```{r}
summary(influence.measures(finalmodel))
```

## Actividad II

<p align = "justify">
Responda las preguntas del archivo Actividad II.Rmd en los espacios señalados. </p>